% !TEX root = scombinatorics.tex
\documentclass[scombinatorics.tex]{subfiles}
\begin{document}
\chapter{Stability}
\label{sauer}



\def\medrel#1{\parbox[t]{5ex}{$\displaystyle\hfil #1$}}
\def\ceq#1#2#3{\parbox[t]{20ex}{$\displaystyle #1$}\medrel{#2}{$\displaystyle #3$}}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{The order property}\label{ladder}

The \emph{chain index\/} of $\phi(\U\,;b)_{b\in\V}$, or of $\phi(x\,;z)$ when $\U$ and $\V$ are clear, is the maximal length of a chain of the form

\ceq{\ssf{ch}\hfill\phi(A\,;b_0)\ \subset}{\dots}{\subset\ \phi(A\,;b_n)}

for some set $A\subseteq\U$ and some $b_0,\dots,b_n\in\V$.
Note that we allow $\phi(A\,;b_0)$ to be empty.
This choice produces a small asymmetry in the definition of ladder; see also Fact~\ref{fact_stability_dual}.


\begin{example}
  If $\phi(\U\,;b)_{b\in\V}$ consists of just one set, the ladder index is $1$.
  If it contains two distinct sets, the  chain index is at least $2$ and it is exactly $2$ if there are no more two sets, or if all sets are disjoint.\QED
\end{example}

If a maximal length does not exist, we say that $\phi(x\,;z)$ is \emph{unstable,} or that it has the \emph{order-property.} 
Otherwise we say that it is \emph{stable.}

In place of requiring the existence of a chain as in \ssf{ch}, we could equivalently equivalently ask for a pair of tuples $a_1,\dots,a_n\in\U$ and $b_0,\dots,b_n\in\V$ such that

\ceq{\ssf{ld}\hfill\phi(a_h\,;b_k)}
{\IFF}
{h\le k.}

We call this pair of tuples a \emph{ladder\/} of length $n+1$.
We may also say \emph{ladder index\/} instead of chain index.
Setting $A=\{a_1,\dots,a_n\}$ we easily obtain a chain from a ladder, the converse is left as an easy exercise for the reader.

\begin{exercise}
  Let $\phi(x\,;z)$ have chain index $n+1$ or more. 
  Let $A\subseteq\U$ be a minimal set such that a chain as in \ssf{ch} obtains for some $b_0,\dots,b_n\in\V$.
  Prove that there is a ladder $a_1,\dots,a_n$ and $b_0,\dots,b_n$ such that $A=\{a_1,\dots,a_n\}$ and conclude that $\phi(x\,;z)$ has ladder index $n+1$.\QED
\end{exercise}

The following is obvious but worth noting.

\begin{fact}\label{fact_stability_dual}
  Let $\phi(x\,;z)$ have ladder index $n+1$. 
  Then $\phi(x\,;z)^{\rm op}$ has ladder index $n$ or $n+1$.\QED
\end{fact}
 
The following definition is connected with those above, though in a less evident manner.
We write ${}^n2$ for the set of binary sequences of length $n$ or, more precisely, the set of functions $s:[n)\to[2)$.
We write $s_h$ for the value of $s$ at $h$, and $s{\restriction} h$ for the restriction of $s$ to $[h)$.
We define ${}^{<n}2=\big\{r\, :\, r\in {}^h2,\ h\in[n)\big\}$.

A \emph{branching tree\/} of hight $n$ for the formula $\phi(x\,;z)$ is a function 

\ceq{\hfill\bar{a}\ :\ {}^{<n}2}{\to}{\U}
\nopagebreak[4]\par
\ceq{\hfill r}{\mapsto}{a_r}\hfill which we may also write as $\bar a=\<a_r:r\in{}^{<n}2\>$

such that

\ceq{\ssf{2r}\hfill\0}
{\neq}
{\bigcap_{h=0}^n\neg^{s_h}\,\phi(a_{s\restriction h}\,;\V)}

where $\neg^i$ is a negation for $i=1$ and an empty symbol for $i=0$.
In other words \ssf{2r} requires the existence of some $\<b_s:s\in{}^n2\>$ such that

\ceq{\hfill\phi(a_{s\restriction h}\,;b_s)}
{\IFF}
{s_h=1}\hfill for all pairs $s\in {}^n2$ and $h\in[n)$

or, with slightly different notation,

\ceq{\hfill\phi(a_r\,;b_s)}
{\IFF}
{r^\frown1\subseteq s}\hfill for all pairs $r\subset s\in {}^n2$.

It helps to represent a branching tree as follows.
For definiteness, fix $n=3$.
Consider a full binary tree of height $n+1$ and assign to each node different from root and leaves a formula as depicted below.
Then \ssf{2r} requires that all formulas in each branch $s\in2^n$ are satified by some $b_s\in\V$.
\medskip

% Set the overall layout of the tree
\tikzstyle{level 1}=[level distance=3.5cm, sibling distance=2.5cm]
\tikzstyle{level 2}=[level distance=3.5cm, sibling distance=1.2cm]
\tikzstyle{level 3}=[level distance=2.5cm, sibling distance=0.5cm]
\tikzstyle{level 4}=[level distance=0.5cm, sibling distance=0.5cm]

% Define styles for bags and leafs
\tikzstyle{bag0} = [text width=2.5ex, align=left]
\tikzstyle{bag} = [text width=7.5ex, align=right]
%\tikzstyle{end} = [circle, minimum width=3pt,fill, inner sep=0pt]

\begin{tikzpicture}[grow=right]
\node[bag0] {{$\top$}}
    child {
        node[bag] {$\phi(a_{\0};z)$}      
            child {
                node[bag] {$\phi(a_1;z)$}
                    child {
                       node[bag] {\footnotesize$\phi(a_{11};z)$\rlap{ ----- $b_{111}$}}
                       edge from parent
                    }    
                    child {
                       node[bag] {\footnotesize$\llap{$\neg$}\phi(a_{11};z)$\rlap{ ----- $b_{110}$}}
                       edge from parent
                    }  
                 edge from parent
            }
            child {
                node[bag] {\llap{$\neg$}$\phi(a_1;z)$}
                edge from parent
                    child {
                       node[bag] {\footnotesize$\phi(a_{10};z)$\rlap{ ----- $b_{101}$}}
                       edge from parent
                    }    
                    child {
                       node[bag] {\footnotesize\llap{$\neg$}$\phi(a_{10};z)$\rlap{ ----- $b_{100}$}}
                       edge from parent
                    }  
                 edge from parent
            }
       edge from parent 
    }
    child {
        node[bag] {\llap{$\neg$}$\phi(a_{\0};z)$}         
            child {
                node[bag] {$\phi(a_0;z)$}
                    child {
                       node[bag] {\footnotesize$\phi(a_{01};z)$\rlap{ ----- $b_{011}$}}
                       edge from parent
                    }    
                    child {
                       node[bag] {\footnotesize\llap{$\neg$}$\phi(a_{01};z)$\rlap{ ----- $b_{010}$}}
                       edge from parent
                    }  
                 edge from parent
            }
            child {
                node[bag] {\llap{$\neg$}$\phi(a_0;z)$}
                edge from parent
                    child {
                       node[bag] {\footnotesize$\phi(a_{00};z)$\rlap{ ----- $b_{001}$}}
                       edge from parent
                    }    
                    child {
                       node[bag] {\footnotesize\llap{$\neg$}$\phi(a_{00};z)$\rlap{ ----- $b_{000}$}}
                       edge from parent
                    }  
                 edge from parent
            } 
        edge from parent
    };
\end{tikzpicture}
\smallskip


We call the maximal height of a branching tree for $\phi(x\,;z)$ the \emph{2-rank\/} of  $\phi(x\,;z)$.
If such a maximal integer does not exist, we say that the 2-rank is infinite.

For the theorem below we need the following Ramsey-like lemma.

\begin{lemma}\label{lem_Ramsey_on_trees}
  Let $\bar a=\<a_r\, :\, r\in{}^{<2m}2\>$ be a branching tree for $\phi(x\,;z)$.
  Let $k\in[2m]$ be given.
  Then, for every $2$-coloring of $\range(\bar a)$, there is a branching tree $\bar a'=\<a'_r\, :\, r\in{}^m2\>$ such that  $\range(\bar a')$ is a monochromatic subset of $\range(\bar a)$.\QED
\end{lemma}

As it happens, a more general lemma is easier to prove.

\begin{lemma}
  Let $\bar a=\<a_r\, :\, r\in{}^{<n}2\>$ be a branching tree for $\phi(x\,;z)$.
  Let $k\in[n]$ be given.
  Then, for every red-blue coloring of $\range(\bar a)$,  there is a branching tree $\bar a'=\<a'_r\, :\, r\in{}^{n'}2\>$ such that $\range(\bar a')\subseteq\range(\bar a)$ and, either all nodes of $\bar a'$ are red and $n'=k$, or they are all blue and $n'=n-k$.
\end{lemma}

\begin{proof}
  Induction on $n$. If $k=0$ or $k=n$, the lemma is trivially true.
  In particular the lemma holds for $n=0$.

  Assume the lemma true for $n$ and prove it for $n+1$.
  Let  $\bar a=\<a_r\, :\, r\in{}^{n+1}2\>$ be given.
  Fix some $k\in[n+1]$. 
  We want a branching tree $\bar a'$ that is either red of height $k$ or blue of height $n+1-k$.
  
  If we discard the trivial cases, we can assume $k\in(n]$.

  For $i=0,1$ we define $\bar a_i=\<a_{i^\frown r}\;:\;r\in {}^{<n}2\>$.

  First suppose that $a_\0$ is blue.
  If, for either $i=0$ or $i=1$, there is a red branching tree $\bar a'_i$ of height $k$, we are done.
  Otherwise, for both $i=0,1$ there is a blue branching tree $\bar a'_i$ of hight $n-k$.
  Then we graft these two trees on $a_\0$, which is also blue, and obtain the required blue tree of height $n-k+1$.
  
  Now suppose that $a_\0$ is red.
  If, for either $i=0$ or $i=1$, there is a blue branching tree $\bar a'_i\subseteq \bar a_i$ of height $n-(k-1)$, we are done.
  Otherwise, we graft on $a_\0$ two red trees of hight $k-1$ to obtain a red tree of height $k$.  
\end{proof}

\begin{theorem}
  The following are equivalent
  \begin{itemize}
    \item[1.] $\phi(x\,;z)$ is stable;
    \item[2.] $\phi(x\,;z)$ has finite 2-rank.
  \end{itemize}
  Precisely, if $n_{\rm ld}$ and $n_{\rm 2r}$ are the ladder index and the 2-rank, respectively, then 
  
  \ceq{\hfill n_{\rm ld}}{<}{2^{n_{\rm 2r}+1}.}

  \ceq{\hfill n_{\rm 2r}}{<}{2^{n_{\rm ld}+1}+1.}
\end{theorem}

\begin{proof}
  % \def\ceq#1#2#3{\parbox[t]{29ex}{$\displaystyle #1$}\medrel{#2}{$\displaystyle #3$}}
  % \ssf{1}$\IMP$\ssf{2} 
  % We prove the contrapositive.
  % If there is a binary tree of hight $n$ then there is a ladder of length $n$.
  % This also proves the first inequality of the proposition.

  % Let $\{a_s\; :\; s\in2^{<n}\}$ and $\{b_s\; :\; s\in2^{n}\}$ satisfy \ssf{2r}.
  % Apply \ssf{2r} to sequences of the form $1^k\,0^{n-k}$ for $0\le k\le n$.

  % % Define $a'_1,\dots,a'_n$ and $b'_0,\dots,b'_n$, where $a'_h=a_{1^{h-1}}$ and $b'_k=b_{1^k0^{n-k}}$.
  % % By \ssf{2r} we have

  % \ceq{\hfill\phi(a_{1^k\,0^{n-k}\,\restriction\, h-1}\;;\,b_{1^k\,0^{n-k}})}
  % {\IFF}
  % {\big(1^k0^{n-k}\big)_{h-1}=1}

  % \ceq{}
  % {\IFF}
  % {h\le k}

  (\ssf{2}$\IMP$\ssf{1}) 
  We prove the contrapositive.
  We show that if there is a ladder of length $m=2^n$, say $a_1,\dots,a_{m-1}$ and $b_0,\dots,b_{m-1}$, then there is a branching tree $\bar a'$ of height $n$.
  This also proves the first inequality above.
  In fact, otherwise $n_{\rm ld}\ge 2^{n_{\rm 2r}+1}$ and there would exist a branching tree of height $n_{\rm 2r}+1$ which is a contradiction.
  
  The branching tree $\bar a'=\<a'_r\, :\, r\in{}^{<n}2\>$ is defined as follows

  \quad $a'_r=a_h$\quad  where $h$ is obtained reading $r^\frown1^\frown0^{n-|r|-1}$ as an $n$-digit binary number.

  To verify \ssf{2r} we define for $s\in{}^n2$ 
  
  \quad $b'_s=b_k$\quad  where $k$ is obtained reading $s$ as an $n$-digit binary number.

  Then it is easy to verify that for all pairs $r\subset s\in{}^n2$

  \ceq{\hfill\phi(a'_r\,;b'_s)}
  {\IFF}
  {\phi(a_h\,;b_k)}

  \ceq{}
  {\IFF}
  {h\le k}

  \ceq{}
  {\IFF}
  {r^\frown1^\frown0^{n-|r|-1}\ \le\ s}\hfill  as $n$-digit binary numbers

  \ceq{}
  {\IFF}
  {r^\frown1\ \subseteq\ s}

  (\ssf{1}$\IMP$\ssf{2})
  We prove the contrapositive.
  We claim that if there is a branching tree of height $2^n+1$ then there is a ladder of length $n$.
  This yields also the second inequality of the theorem.
  In fact, otherwise $n_{\rm 2r}\ge 2^{n_{\rm ld}+1}+1$ and there would exist a latter of length $n_{\rm ld}+1$ which is a contradiction.

  The claim is true when $n=0$ because $a_\0$ and $b_0,b_1$ is a ladder of length $2$.
  Now we assume the claim is true for $n$ and prove it for $n+1$.

  Let $\<a_r\, :\, r\in{}^{<\, 2m+1}2\>$, where $m=2^n$, be a branching tree of height $2^{n+1}+1$.
  To every $b\in\V$ we associate a 2-coloring of $\bar a$.
  A node $a\in\range(\bar a)$ is red if $\phi(a\,;b)$ blue otherwise.

  Case 1. For some $b$ there is a red subtree $\bar a'$ of height $m+1$.
  Consider the subtrees $\bar{a'}_0=\<a'_{0^\frown r}\;:\;r\in {}^{<\,m}2\>$.
  By induction hypothesis there is an $A'\subseteq\range(\bar a'_0)$ and some $b'_0,\dots,b'_n\in\neg\phi(a'_\0\,;\V)$ such that

  \ceq{(1)\hfill\phi(A'\,;b'_0)\ \subset}{\dots}{\subset\ \phi(A'\,;b'_n)}

  By the choice of $b'_0,\dots,b'_n$, this chain stays unchanged if we replace $A'$ by $A''=A'\cup\{a'_\0\}$.
  Therefore we obtain the required chain of length $n+1$ extending (1) with $\phi(A'',b)=A''$.
  
  Case 2. For every $b$ there is a blue subtree $\bar a'$ of height $m$.
  Choose $b$ such that $\phi(a_\0, b)$ and apply the induction hypothesis to obtain $A'\subseteq\range(\bar a')$ and $b'_0,\dots,b'_n$ such that

  \ceq{(1)\hfill\phi(A'\,;b'_0)\ \subset}{\dots}{\subset\ \phi(A'\,;b'_n)}

  
  Then $\range(\bar a')\subseteq\{a_{0^\frown r}\;:\;r\in {}^{<\,m}2\}$ 

  To every $b\in\phi(a_\0\,;\V)$ we associate a 2-coloring of $\bar a_0$ given by the truth of $\phi(a\,b)$ for $a\in\range(\bar a_0)$
  
  
  There are two cases.

  Case 1. There is a a branching tree $\bar a_0'$ of height $m$ such that $\range(\bar a'_0)\subseteq\range(\bar a_0)$ and $\phi(a'\,b)$ for all $a'\in\range(\bar a')$.

  By induction hypothesis, there is an $A\subseteq\range(\bar a')$ and some $b_0,\dots,b_n\in\neg\phi(a_\0\,;\V)$ such that 

  \ceq{(1)\hfill\phi(A\,;b_0)\ \subset}{\dots}{\subset\ \phi(A\,;b_n)}

  By the choice of $b_0,\dots,b_n$, this chain stays unchanged if we replace $A$ by $A'=A\cup\{a_\0\}$.
  Therefore we obtain the required chain of length $n+1$ extending (1) with $\phi(A',b)=A'$.
  
  %\ceq{\hfill\phi(A'\,;b'_0)\ \subset}{\dots}{\subset\ \phi(A'\,;b_n)\ \subset\ \phi(A',b)}

  For some $b$ like above the is a 

  Case 1.
  For either $i=0$ or $i=1$, there is a $b$ that witness the non emptiness of some branch in the tree $\bar a_i$ and $\neg^i\phi(a,b)$ holds for all $a\in\range(\bar a_i)$.  
  
  $A'=\{a_{r}\;:\;r\in {}^{<\,m}2\}\subseteq A$ such that $\phi(A'\,b_{r^\frown1})=A'$.
  By the induction hypothesis there is $A''\subseteq A'$ such that for some $b'_0,\dots,b'n\in B$

  \ceq{\hfill\phi(A'\,;b'_0)\ \subset}{\dots}{\subset\ \phi(A'\,;b'_n)}


  \ceq{\hfill\phi(A'\,;b'_0)\ \subset}{\dots}{\subset\ \phi(A'\,;b'_n)}

  Let $A_i\subseteq A$ and $B_i\subseteq B$ be as in the proof of the lemma above, with $2m$ for $n$.

  % Note that $B_0$ and $B_1$ are disjoint sets, in fact $B_0=\neg\phi(a_\0\,;B)$ and $B_1=\phi(a_\0\,;B)$.

  Color red the elements of $A_0$ such that $\phi(a,b)$, blue otherwise.
  Let $k=2^n$.

  By induction hypothesis there are $a_1,\dots,a_{2^n}\in A_0$ and $B\subseteq B_0$ such that

  \ceq{\hfill\phi(a_0\,;B)\ \subset}{\dots}{\subset\ \phi(a_m\,;B)}

  Pick any $b\in B\sm B_0$.
  If the are $m/2$ sets in the chain such that $\phi(a_0\,;b)$ then set 


  \ceq{\hfill\phi(a_0\,;B'_0)\ \subset}{\dots}{\subset\ \phi(a_m\,;B'_0)}


  Color the pairs $\{h,k\}\in [m)^{(2)}$ if

  We claim that there are $a'_1,\dots,a'_{m'}$ 

  \ceq{\hfill\phi(a'_0\,;B')\ \subset}{\dots}{\subset\ \phi(a'_{m'}\,;B')}



\end{proof}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Approximable sets}

We say that $\Aa\subseteq\U$ is \emph{approximable\/} if for every finite set $A\subseteq\U$ there is a $b\in\V$ such that $\phi(A\,;b)=\Aa\cap A$.
If we also have that $\phi(\U\,;b)\subseteq\U$, then we say that $\Aa\subseteq\U$ is approximable \emph{from below.} The following is immediate.

\begin{fact}
  The following are equivalent
  \begin{itemize}
    \item[1.] $\Aa\subseteq\U$ is approximable from below;
    \item[2.] for every finite set $A\subseteq\Aa$ there is a $b\in\V$ such that $A\subseteq\phi(\U\,;b)\subseteq\Aa$.\QED
  \end{itemize}
\end{fact}

% \begin{lemma}
%   Let $\psi_i(x\,;z)$ have ladder index $n_i$, then $\phi(x\,;z)=\psi_1(x\,;z)\wedge\psi_2(x\,;z)$ has ladder index 

%   \ceq{\hfill n}{<}{R(n_1,n_2)}

%   where $R(n_1,n_2)$ is the Ramsey number for 2-colorings of cardinality $n_1,n_2$ that is known to be

%   \ceq{ }{\le}{\binom{n_1 + n_2 - 2}{n_1 - 1}}
% \end{lemma}

% \begin{proof} 
%   Suppose for a contradiction that $\phi(x\,;z)$ has ladder index ${\ge\,}n$.
%   Then \ssf{ld} holds for some $a_1,\dots,a_n$ and $b_0,\dots,b_n$.
%   Let $C_i$ contains the pairs $\{h,k\}$ such that $0\le k<h\le n$ and $\neg\psi_i(a_h\,;b_k)$.
%   Then from \ssf{ld} we obtain $C_1\cup C_2= \{0,\dots,n\}^{(2)}$.
  
%   By the definition of $n$, for $i{=}1$ or $2$, there is a set $H$ of cardinality $n_i$ such that $H^{(2)}\subseteq C_i$.
%   Assume $i{=}1$ for definiteness.

%   Write $a'_1,\dots,a'_{n_1}$ and $b'_0,\dots,b'_{n_1}$ for the tuples obtained by restricting $a_1,\dots,a_n$ and $b_0,\dots,b_n$ to the indexes in $H$.
%   These tuples witness that $\psi_1(x\,;z)$ has ladder index at least $n_1$, which contradicts the assumption of the lemma.
% \end{proof}
  
\begin{lemma}
  Let $\psi_i(x\,;z)$, where $i=1,\dots,m$, be formulas with ladder index $n_i$. Let
  
  \ceq{\hfill \phi(x\,;z)}{=}{\bigwedge_{i=1}^m\psi_i(x\,;z)}
  
  Then $\phi(x\,;z)$ has ladder index $<R(n_1,\dots, n_m)$, the Ramsey number for $m$-colorings.
\end{lemma}
  
\begin{proof} 
  Suppose for a contradiction that there is a ladder $a_1,\dots,a_n$ and $b_0,\dots,b_n$ of length $n=R(n_1,\dots, n_m)$.
  Let $C_i$ contains the pairs $\{h,k\}$ such that $0\le k<h\le n$ and $\neg\psi_i(a_h\,;b_k)$.
  Then from \ssf{ld} we obtain 
  
  \ceq{\hfill\bigcup_{i=1}^mC_i}{=}{\{0,\dots,n\}^{(2)}}
  
  By the definition of $n$, for some $i\in[m]$, there is a set $H$ of cardinality $n_i$ such that $H^{(2)}\subseteq C_i$.
  Assume $i{=}1$ for definiteness.

  Write $a'_1,\dots,a'_{n_1}$ and $b'_0,\dots,b'_{n_1}$ for the tuples obtained by restricting $a_1,\dots,a_n$ and $b_0,\dots,b_n$ to the indexes in $H$.
  These tuples witness that $\psi_1(x\,;z)$ has ladder index at least $n_1$, which contradicts the assumption of the lemma.
\end{proof}
  

\end{document}